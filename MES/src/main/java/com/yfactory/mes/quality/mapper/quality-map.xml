<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yfactory.mes.quality.mapper.QualityMapper">
	<!-- 조회 -->
	<!-- 불량코드(modal) 조회 -->
	<select id="selectErrCode" resultType="map">
		SELECT	ERR_CD "불량코드", ERR_NM "불량명"
		FROM	ERR_CODE
	</select>

	
	<!-- 자재 품질검사요청(modal) 조회 -->
	<select id="selectpoDtlRequest" resultType="map">
		SELECT  MPD.PO_DTLCD as "발주상세코드",
		        MT.MT_CD as "자재코드",
		        MT.MT_NM as "자재명",
		        VDR.VDR_NM as "업체명",
		        MPD.PO_QTY as "발주량"
		FROM 	MT_PODTL MPD, MT MT, VENDOR VDR, MT_PO MP
		WHERE 	MPD.PO_CD = MP.PO_CD
		AND     MP.MT_CD = MT.MT_CD
		AND     MP.VDR_CD = VDR.VDR_CD
		AND	    MPD.PO_DTLCD NOT IN (SELECT PO_DTLCD
                                     FROM MT_CHK)
	</select>
	
	
	<!-- 자재검사관리 -->
	<select id="selectMtCheckMgr" resultType="map">
		SELECT 	MP.PO_CD "발주코드", CHK.PO_DTLCD "발주상세코드", MT.MT_CD "자재코드", 
				MT.MT_NM "자재명", EMP.EMP_NM "담당인", MPD.PO_QTY "발주량", CC.CD_NM "상태"
				
		FROM 	MT_PODTL MPD, MT_PO MP, MT MT, COMM_CODE CC, MT_CHK CHK, EMPLOYEE EMP
		
		WHERE 	MPD.PO_CD = MP.PO_CD
		AND 	MP.MT_CD = MT.MT_CD
		AND 	CHK.PO_DTLCD = MPD.PO_DTLCD
		AND		CHK.CHK_MNGR = EMP.EMP_NO
		AND 	CHK.CHK_INSP = CC.COMM_CD
		
		AND 	COMM_CD = 'MTRL01'
	</select>
	
	<!-- 자재검사결과 조회 -->
	<select id="selectMtCheck" resultType="map">
		SELECT	MP.PO_CD "발주코드", MPD.PO_DTLCD "발주상세코드", MT.MT_CD "자재코드", MT.MT_NM "자재명", CHK.CHK_MNGR "담당인",
				TO_CHAR(CHK.CHK_DT, 'YYYY-MM-DD') "검사일자", MPD.PO_QTY "발주량", CHK.CHK_PASSQTY "합격량", MEL.CHK_ERRQTY "불량량",
				MEL.ERR_CD "불량코드", ERR.ERR_DTL "불량내역", CC.CD_NM "상태"
				
		FROM	MT_CHK CHK, MT_PODTL MPD, MT MT, MT_ERRLIST MEL, ERR_CODE ERR, COMM_CODE CC, MT_PO MP
		
		WHERE   MP.PO_CD = MPD.PO_CD	
        AND     CHK.PO_DTLCD = MPD.PO_DTLCD
		AND		CHK.MTRL_CD = MT.MT_CD
		AND		MEL.PO_DTLCD = MPD.PO_DTLCD
		AND 	MEL.ERR_CD = ERR.ERR_CD
		AND 	CHK.CHK_INSP = CC.COMM_CD
		AND 	COMM_CD != 'MTRL01'
		ORDER BY 6
	</select>
	<!-- 제품검사결과 조회 -->
	<select id="selectProdCheck" resultType="map">
		SELECT	PER.PROD_LOT AS "제품LOT",
				PID.PROD_CD AS "제품코드",
				P.PROD_NM AS "제품명",
				PPR.PROC_CD AS "공정코드",
				PC.EQ_CD AS "설비코드",
				PS.PROC_QTY AS "생산량",
				PS.PROC_PASSQTY AS "합격량",
				PE.ERR_QTY AS "불량량",
				PE.ERR_CD AS "불량코드",
				ERR.ERR_DTL AS "불량내역",
				PS.PROC_ST AS "상태"
		
		FROM 	PROD_ERR PER,
				PROD_LOT PLO,
				PRD_INSDTL PID,
				PROC_PRC PPR,
				PROCESS PC,
				PROD P,
				PROC_ST PS,
				PROC_ERR PE,
				ERR_CODE ERR
		
		WHERE 	PER.PROD_LOT = PLO.PROD_LOT
		AND 	PPR.PRD_DTLCD = PID.PRD_DTLCD
		AND 	PPR.PROC_CD = PC.PROC_CD
		AND 	PID.PROD_CD = P.PROD_CD
		AND 	PS.PROC_PRCD = PPR.PROC_PRCD
		AND 	PS.LINE_TURN = PPR.LINE_TURN
		AND 	PS.PRD_DTLCD = PPR.PRD_DTLCD
		AND 	PE.PROC_PRCD = PPR.PROC_PRCD
		AND 	PE.LINE_TURN = PPR.LINE_TURN
		AND 	PE.PRD_DTLCD = PPR.PRD_DTLCD
		AND 	PE.ERR_CD = ERR.ERR_CD
	</select>
	
	<!-- 자재불량내역 조회 -->
	<select id="selectMtErrList" resultType="map">
		SELECT	MPD.PO_CD AS "발주코드",
                MEL.PO_DTLCD AS "발주상세코드",
				TO_CHAR(CHK.CHK_DT, 'YYYY-MM-DD') AS "검사일자",
				V.VDR_NM AS "업체명",
				MT.MT_NM AS "자재명",
				MEL.CHK_ERRQTY AS "불량량",
				ERR.ERR_DTL AS "불량내역",
				MT.MT_PRC AS "단가",
				(MEL.CHK_ERRQTY * MT.MT_PRC) "청구금액"
		
		FROM 	MT_PODTL MPD,
                MT_CHK CHK,
				VENDOR V,
				MT_ERRLIST MEL,
				ERR_CODE ERR,
				MT MT
		
		WHERE MPD.PO_DTLCD = CHK.PO_DTLCD
        AND  MEL.PO_DTLCD = CHK.PO_DTLCD
		AND 	MEL.MTRL_CD = MT.MT_CD
        AND 	MT.VDR_CD = V.VDR_CD
		AND 	MEL.ERR_CD = ERR.ERR_CD
        ORDER BY 1
	</select>
	
	<!-- 제품불량내역 조회 -->
	<select id="selectProdErrList" resultType="map">
		SELECT 	PERR.PROD_LOT "제품LOT",
        		PL.PROD_CD "제품코드",
        		P.PROD_NM "제품명",
        		PERR.CHK_ERRQTY "불량량",
        		PERR.ERR_CD "불량코드",
        		ERR.ERR_DTL "불량내역"
		FROM 	PROD_ERR PERR, PROD_LOT PL, PROD P, ERR_CODE ERR
		WHERE	PERR.PROD_LOT = PL.PROD_LOT
		AND 	PL.PROD_CD = P.PROD_CD
		AND 	PERR.ERR_CD = ERR.ERR_CD
	</select>

	<!-- 검색 -->
	<!-- 불량코드(modal) 검색 -->
	<select id="searchErrName" resultType="map">
		SELECT 	*
		FROM 	ERR_CODE
		WHERE	ERR_NM LIKE '%' || #{errName} || '%'
	</select>
	
	<!-- 자재 품질검사요청(modal) 조회 -->
	<select id="searchpoDtlRequest" resultType="map">
		SELECT	MPD.PO_DTLCD AS "발주상세코드",
				MP.MT_CD AS "자재코드",
				MT.MT_NM AS "자재명",
				VDR.VDR_NM AS "업체명",
				MPD.PO_QTY "발주량"
		FROM	MT_PODTL MPD,
				MT_PO MP,
				MT MT,
				VENDOR VDR
		WHERE	MPD.PO_CD = MP.PO_CD
		AND		MP.MT_CD = MT.MT_CD
		AND 	MP.VDR_CD = VDR.VDR_CD
		<if test="mtName != ''">
		AND 	MT.MT_NM LIKE '%' || #{mtName} || '%'
		</if>
	</select>
	
	<!-- 자재검사결과 검색 -->
	<select id="searchMtQuality" resultType="map">
		SELECT  CHK.PO_DTLCD AS "발주상세코드",
		        CHK.CHK_DT AS "검사일자",
		        V.VDR_NM AS "업체명",
		        MT.MT_NM AS "자재명",
		        MT.MT_UNIT AS "관리단위",
		        MPD.PO_QTY AS "발주량",
		        CHK.CHK_PASSQTY AS "합격량",
		        MEL.CHK_ERRQTY AS "불량량",
		        MEL.ERR_CD AS "불량코드",
		        ERR.ERR_DTL AS "불량내역",
		        CHK.CHK_INSP AS "상태"
		
		FROM 	MT_CHK CHK,
				MT_PO PO,
				MT MT,
				MT_PODTL MPD,
				MT_ERRLIST MEL,
				ERR_CODE ERR,
		        VENDOR V
		
		WHERE	CHK.PO_DTLCD = MPD.PO_DTLCD
		AND 	CHK.MTRL_CD = MT.MT_CD
		AND 	MPD.PO_CD = PO.PO_CD
		AND 	PO.VDR_CD = V.VDR_CD
		AND		MEL.PO_DTLCD = MPD.PO_DTLCD
		AND		MEL.ERR_CD = ERR.ERR_CD
		<if test="startDate != null and endDate !=null">
		AND		CHK.CHK_DT BETWEEN TO_DATE(#{startDate}, 'YYYY-MM-DD') AND TO_DATE(#{endDate}, 'YYYY-MM-DD')
		</if>
		<if test="mtName != null and mtName = ''">
		AND 	MT.MT_NM LIKE '%' || {#mtName} || '%'
		</if>
	</select>
	
	<!-- 제품검사결과 검색 -->
	<select id="searchProdQuality" resultType="map">
		SELECT	PER.PROD_LOT AS "제품LOT",
				PID.PROD_CD AS "제품코드",
				PPR.PROC_CD AS "공정코드",
				PC.EQ_CD AS "설비코드",
				P.PROD_NM AS "제품명",
				PS.PROC_QTY AS "생산량",
				PS.PROC_PASSQTY AS "합격량",
				PE.ERR_QTY AS "불량량",
				PE.ERR_CD AS "불량코드",
				ERR.ERR_DTL AS "불량내역",
				PS.PROC_ST AS "상태"
		
		FROM 	PROD_ERR PER,
				PROD_LOT PLO,
				PRD_INSDTL PID,
				PROC_PRC PPR,
				PROCESS PC,
				PROD P,
				PROC_ST PS,
				PROC_ERR PE,
				ERR_CODE ERR
		
		WHERE 	PER.PROD_LOT = PLO.PROD_LOT
		AND 	PPR.PRD_DTLCD = PID.PRD_DTLCD
		AND 	PPR.PROC_CD = PC.PROC_CD
		AND 	PID.PROD_CD = P.PROD_CD
		AND 	PS.PROC_PRCD = PPR.PROC_PRCD
		AND 	PS.LINE_TURN = PPR.LINE_TURN
		AND 	PS.PRD_DTLCD = PPR.PRD_DTLCD
		AND 	PE.PROC_PRCD = PPR.PROC_PRCD
		AND 	PE.LINE_TURN = PPR.LINE_TURN
		AND 	PE.PRD_DTLCD = PPR.PRD_DTLCD
		AND 	PE.ERR_CD = ERR.ERR_CD
		<if test="prodName != null">
		AND		P.PROD_NM LIKE '%' || {#prodName} || '%'
		</if>
	</select>
	
	<!-- 자재불량내역 검색 -->
	<select id="searchMtErrList" resultType="map">
		SELECT	MEL.PO_DTLCD AS "발주상세코드",
				CHK.CHK_DT AS "검사일자",
				V.VDR_NM AS "업체명",
				MT.MT_NM AS "자재명",
				MEL.CHK_ERRQTY AS "불량량",
				ERR.ERR_DTL AS "불량내역",
				MPD.MT_PRC AS "단가"
		
		FROM 	MT_CHK CHK,
				MT_PODTL MPD,
				MT_PO PO,
				VENDOR V,
				MT_ERRLIST MEL,
				ERR_CODE ERR,
				MT MT
		
		WHERE 	MEL.PO_DTLCD = MPD.PO_DTLCD
		AND		MPD.PO_CD = PO.PO_CD
		AND 	PO.VDR_CD = V.VDR_CD
		AND 	MEL.MTRL_CD = MT.MT_CD
		AND 	MEL.ERR_CD = ERR.ERR_CD
		<if test="errDtl != null errDtl = ''">
		AND		ERR.ERR_DTL LIKE '%' || {#errDtl} || '%'
		</if>
		<if test="mtName != nul mtName = ''">
		AND 	MT.MT_NM LIKE '%' || {#mtName} || '%'
		</if>
	</select>
	
	<!-- 제품불량내역 검색 -->
	<select id="searchProdErrList" resultType="map">
		SELECT	PER.PROD_LOT AS "제품LOT",
				PPR.PROC_CD AS "공정코드",
				PE.LINE_TURN AS "순번",
				P.PROD_NM AS "제품명",
				PER.CHK_ERRQTY AS "불량량",
				PE.ERR_CD AS "불량코드",
				ERR.ERR_DTL AS "불량내역",
				PS.PROC_ST AS "상태"
		
		FROM 	PROD_ERR PER,
				PROD_LOT PLO,
				PRD_INSDTL PID,
				PROC_PRC PPR,
				PROC_ST PS,
				PROC_ERR PE,
				ERR_CODE ERR,
				PROD P
		
		WHERE	PER.PROD_LOT = PLO.PROD_LOT
		AND		PID.PROD_CD = P.PROD_CD
		AND 	PS.PROC_PRCD = PPR.PROC_PRCD
		AND 	PS.LINE_TURN = PPR.LINE_TURN
		AND 	PS.PRD_DTLCD = PPR.PRD_DTLCD
		AND 	PE.PROC_PRCD = PPR.PROC_PRCD
		AND 	PE.LINE_TURN = PPR.LINE_TURN
		AND 	PE.PRD_DTLCD = PPR.PRD_DTLCD
		AND 	PE.ERR_CD = ERR.ERR_CD
		<if test="errDtl != null and errDtl = ''">
		AND		ERR.ERR_DTL LIKE '%' || {#errDtl} || '%'
		</if>
		<if test="prodName != null and prodName = ''">
		AND 	P.PROD_NM LIKE '%' || {#prodName} || '%'
		</if>
	</select>
	
	<!-- 입력 -->
	<!-- 자재 품질검사요청 -->
	<insert statementType="CALLABLE" id="reqMtQuality" parameterType="map">
		{CALL QUALITY_REQ_INSERT (#{pdt}, #{mcd})}
	</insert>
	
	<!-- 수정 -->
	<!-- 자재 품질검사 -->
	<update statementType="CALLABLE" id="resMtQuality" parameterType="map">
		{CALL QUALITY_RES_UPDATE (#{podtlcd}, #{mtnm}, #{passqty}, #{errqty}, #{errcd})}
	</update>
</mapper>