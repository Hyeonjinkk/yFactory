<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yfactory.mes.quality.mapper.QualityMapper">
	<!-- 조회 -->
	<!-- 불량코드(modal) 조회 -->
	<select id="selectErrCode" resultType="map">
		SELECT	ERR_CD "불량코드", ERR_NM "불량명"
		FROM	ERR_CODE
	</select>

	
	<!-- 자재 품질검사요청(modal) 조회 -->
	<select id="selectpoDtlRequest" resultType="map">
SELECT  		MP.PO_CD "발주코드", 
        			MP.PO_REQDT "발주신청일", 
        			E.EMP_NM "발주신청인"
FROM    		MT_PO MP, EMPLOYEE E, MT_CHK MK
WHERE  		 MP.EMP_NO = E.EMP_NO
AND    		 mk.po_cd(+) = mp.po_cd
AND     		mk.po_cd IS NULL
	</select>
	
	
	<!-- 자재검사관리 -->
	<select id="selectMtCheckMgr" resultType="map">
		SELECT
				 DISTINCT
				MCD.PO_CD "발주코드",
		       MPD.PO_DTLCD "발주상세코드",
		       MCD.CHK_CD "품질검사코드", 
		       MCD.MT_CD "자재코드", 
		       M.MT_NM "자재명",
		       E.EMP_NM "담당인",
		       MPD.PO_QTY "발주량", 
		       CC.CD_NM "상태"
		FROM   MT_CHK_DTL MCD, 
		       MT_CHK MC,
		       EMPLOYEE E,
		       MT M, 
		       MT_PODTL MPD, 
		       COMM_CODE CC
		WHERE MCD.MT_CD = M.MT_CD
		AND MCD.CHK_DTL_INSP = CC.COMM_CD
		AND MCD.PO_CD = MPD.PO_CD
		AND M.MT_CD = MPD.MT_CD
		AND MC.CHK_MNGR = E.EMP_NO
		AND MCD.CHK_DTL_INSP = 'MTRL01'
		ORDER BY 1
	</select>
	
	<!-- 자재검사결과 조회 -->
	<select id="selectMtCheck" resultType="map">
		SELECT	MP.PO_CD "발주코드", MPD.PO_DTLCD "발주상세코드", MT.MT_CD "자재코드", MT.MT_NM "자재명", CHK.CHK_MNGR "담당인",
				TO_CHAR(CHK.CHK_DT, 'YYYY-MM-DD') "검사일자", MPD.PO_QTY "발주량", CHK.CHK_PASSQTY "합격량", MEL.CHK_ERRQTY "불량량",
				MEL.ERR_CD "불량코드", ERR.ERR_DTL "불량내역", CC.CD_NM "상태"
				
		FROM	MT_CHK CHK, MT_PODTL MPD, MT MT, MT_ERRLIST MEL, ERR_CODE ERR, COMM_CODE CC, MT_PO MP
		
		WHERE   MP.PO_CD = MPD.PO_CD	
        AND     CHK.PO_DTLCD = MPD.PO_DTLCD
		AND		CHK.MTRL_CD = MT.MT_CD
		AND		MEL.PO_DTLCD = MPD.PO_DTLCD
		AND 	MEL.ERR_CD = ERR.ERR_CD
		AND 	CHK.CHK_INSP = CC.COMM_CD
		AND 	COMM_CD != 'MTRL01'
		ORDER BY 6
	</select>
	<!-- 제품검사결과 조회 -->
	<select id="selectProdCheck" resultType="map">
		SELECT	PER.PROD_LOT AS "제품LOT",
				PID.PROD_CD AS "제품코드",
				P.PROD_NM AS "제품명",
				PPR.PROC_CD AS "공정코드",
				PC.EQ_CD AS "설비코드",
				PS.PROC_QTY AS "생산량",
				PS.PROC_PASSQTY AS "합격량",
				PE.ERR_QTY AS "불량량",
				PE.ERR_CD AS "불량코드",
				ERR.ERR_DTL AS "불량내역",
				PS.PROC_ST AS "상태"
		
		FROM 	PROD_ERR PER,
				PROD_LOT PLO,
				PRD_INSDTL PID,
				PROC_PRC PPR,
				PROCESS PC,
				PROD P,
				PROC_ST PS,
				PROC_ERR PE,
				ERR_CODE ERR
		
		WHERE 	PER.PROD_LOT = PLO.PROD_LOT
		AND 	PPR.PRD_DTLCD = PID.PRD_DTLCD
		AND 	PPR.PROC_CD = PC.PROC_CD
		AND 	PID.PROD_CD = P.PROD_CD
		AND 	PS.PROC_PRCD = PPR.PROC_PRCD
		AND 	PS.LINE_TURN = PPR.LINE_TURN
		AND 	PS.PRD_DTLCD = PPR.PRD_DTLCD
		AND 	PE.PROC_PRCD = PPR.PROC_PRCD
		AND 	PE.LINE_TURN = PPR.LINE_TURN
		AND 	PE.PRD_DTLCD = PPR.PRD_DTLCD
		AND 	PE.ERR_CD = ERR.ERR_CD
	</select>
	
	<!-- 자재불량내역 조회 -->
	<select id="selectMtErrList" resultType="map">
		SELECT	MPD.PO_CD AS "발주코드",
                MEL.PO_DTLCD AS "발주상세코드",
				TO_CHAR(CHK.CHK_DT, 'YYYY-MM-DD') AS "검사일자",
				V.VDR_NM AS "업체명",
				MT.MT_NM AS "자재명",
				MEL.CHK_ERRQTY AS "불량량",
				ERR.ERR_DTL AS "불량내역",
				MT.MT_PRC AS "단가",
				(MEL.CHK_ERRQTY * MT.MT_PRC) "청구금액"
		
		FROM 	MT_PODTL MPD,
                MT_CHK CHK,
				VENDOR V,
				MT_ERRLIST MEL,
				ERR_CODE ERR,
				MT MT
		
		WHERE MPD.PO_DTLCD = CHK.PO_DTLCD
        AND  MEL.PO_DTLCD = CHK.PO_DTLCD
		AND 	MEL.MTRL_CD = MT.MT_CD
        AND 	MT.VDR_CD = V.VDR_CD
		AND 	MEL.ERR_CD = ERR.ERR_CD
        ORDER BY 1
	</select>

	<!-- 검색 -->
	<!-- 불량코드(modal) 검색 -->
	<select id="searchErrName" resultType="map">
		SELECT 	*
		FROM 	ERR_CODE
		WHERE	ERR_NM LIKE '%' || #{errName} || '%'
	</select>
	
	<!-- 자재 품질검사요청(modal) 조회 -->
	<select id="searchpoDtlRequest" resultType="map">
		SELECT	MPD.PO_DTLCD AS "발주상세코드",
				MP.MT_CD AS "자재코드",
				MT.MT_NM AS "자재명",
				VDR.VDR_NM AS "업체명",
				MPD.PO_QTY "발주량"
		FROM	MT_PODTL MPD,
				MT_PO MP,
				MT MT,
				VENDOR VDR
		WHERE	MPD.PO_CD = MP.PO_CD
		AND		MP.MT_CD = MT.MT_CD
		AND 	MP.VDR_CD = VDR.VDR_CD
		<if test="mtName != ''">
		AND 	MT.MT_NM LIKE '%' || #{mtName} || '%'
		</if>
	</select>

	<!-- 입력 -->
	<!-- 자재 품질검사요청 -->
	<insert statementType="CALLABLE" id="reqMtQuality" parameterType="map">
		{CALL QUAL_MT_INSERT (#{pdt})}
	</insert>
	
	<!-- 수정 -->
	<!-- 자재 품질검사 -->
	<update statementType="CALLABLE" id="resMtQuality" parameterType="map">
		{CALL QUALITY_RES_UPDATE (#{chkcd}, #{mtnm}, #{passqty}, #{errqty}, #{errcd})}
	</update>
</mapper>