<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yfactory.mes.mtrl.mapper.MtrlMapper">
	<!-- 미지시 생산조회 -->
	<select id="selectPl" resultType="map">
		SELECT    pl.pp_cd "pp_cd",
	       		  pl.pp_nm "pp_nm",
	              pl.pp_dt "pp_dt",
	              sum(dt.pd_qty) "pd_qty"
		FROM      plan_dtl dt, prdt_pl pl
		WHERE     dt.pp_cd = pl.pp_cd
		AND       LOWER(pl.pp_prog) = 'plan01'
		group by  pl.pp_cd, pl.pp_nm, pl.pp_dt
	</select>
	
	<!-- 생산계획별 자재재고 -->
	<select id="mtrlPlanList" resultType="map">
	SELECT 
            P.PROD_CD    "완제품코드",
            P.PROD_NM    "완제품명",
            PL.PP_DT     "계획일자",
            M.MT_CD      "원자재코드",
            M.MT_NM      "원자재명",
            
            CASE
                WHEN     0 > MC.MT_QTY - ( B.CS_QTY * PLD.PD_QTY ) THEN '부족'
                
            END AS "구분"
            
FROM        PROD P, 
            PLAN_DTL PLD, 
            PRDT_PL PL,
            BOM B,
            MT M,
            MT_CURQTY MC,
            MT_LOT ML
WHERE       PL.PP_CD = PLD.PP_CD
AND         P.PROD_CD = B.PROD_CD
AND         M.MT_CD = B.MT_CD
AND         M.MT_CD = ML.MT_CD
AND         ML.MT_LOT = MC.MT_LOT
AND         PL.PP_CD = #{ppCd}

ORDER BY    6 ASC
	</select>
	
	<!-- 발주요청서 등록 조회 -->
	<select id="">
		SELECT   M.MT_CD  "원자재코드",
         		 M.MT_NM  "원자재명",
        		 V.VDR_NM    "업체명",
        		 MC.MT_QTY   "현재고",
         		 SUM(B.CS_QTY * PLD.PD_QTY)   "계획대비 필요수량"
		FROM     MT M, VENDOR V, MT_LOT ML ,MT_CURQTY MC, BOM B, PLAN_DTL PLD
		WHERE    M.VEN_CD = V.VDR_CD
		AND      M.MT_CD = ML.MT_CD
		AND      ML.MT_LOT = MC.MT_LOT
		AND      M.MT_CD = B.MT_CD
		AND      B.PROD_CD = PLD.PROD_CD
		AND      PLD.PP_CD = 'PL220519001'
		AND      M.MT_CD = 'MT001'
		GROUP BY M.MT_CD, M.MT_NM, V.VDR_NM, MC.MT_QTY;
	</select>
	
	<!-- 자재lot재고조회 -->
	<select id="listMtrlLot" resultType="map">
		SELECT lot.mt_lot "mt_lot",
			   lot.mt_cd "mt_cd",
			   m.mt_nm "mt_nm", 
			   vd.vdr_nm "vdr_nm", 
			   cy.mt_qty "mt_qty", 
			   TO_CHAR(lot.mt_exp,'YYYY-MM-DD') "mt_exp"
		FROM   mt_lot lot, 
			   mt m,  
			   vendor vd, 
			   mt_curqty cy
		WHERE  m.mt_cd = lot.mt_cd
		AND    m.ven_cd = vd.vdr_cd
		AND    lot.mt_lot = cy.mt_lot
	</select>
	
	<!-- LOT 검색조회 -->
	<select id="lotSelectSearch" resultType="map">
		SELECT  lot.mt_lot "mt_lot",
			    lot.mt_cd "mt_cd",
			    m.mt_nm "mt_nm", 
			    vd.vdr_nm "vdr_nm", 
			    cy.mt_qty "mt_qty", 
			    TO_CHAR(lot.mt_exp,'YYYY-MM-DD') "mt_exp"
		FROM    mt_lot lot, 
			    mt m,  
			    vendor vd, 
			    mt_curqty cy
		WHERE   m.mt_cd = lot.mt_cd
		AND     m.ven_cd = vd.vdr_cd
		AND     lot.mt_lot = cy.mt_lot
			<if test="m1 != ''">
		AND 	m.mt_nm LIKE '%'||#{m1}||'%'
			</if>
			<if test="m2 != ''">
		AND 	vd.vdr_nm LIKE '%'||#{m2}||'%'
			</if>
			<if test="req1 != '' and req2 != ''">
		AND 	lot.mt_wdt between TO_DATE(#{req1},'YYYY-MM-DD') AND TO_DATE(#{req2},'YYYY-MM-DD')
			</if>
	</select>
	
	<!-- 자재 코드,이름 전체조회 -->
	<select id="mtcdList" resultType="map">
		SELECT mt_nm "mt_nm", 
			   mt_cd "mt_cd"
		FROM   mt
	</select>
	
	<!-- 자재명 단건조회 -->
	<select id="mtnmSelectSearch" resultType="map">
		SELECT mt_nm "mt_nm", 
			   mt_cd "mt_cd"
		FROM   mt
		WHERE  mt_nm LIKE '%'||#{mtnm}||'%'
	</select>
	
	<!-- 업체명 조회 -->
	<select id="vendorList" resultType="map">
		SELECT cd.cd_nm "cd_nm",
      		   vd.vdr_nm "vdr_nm", 
       		   vd.vdr_cd "vdr_cd"
		FROM   vendor vd, COMM_CODE cd
		WHERE  vd.ven_cd = cd.comm_cd
	</select>
	
	<!-- 업체명 단건조회 -->
	<select id="vdrnmSelectSearch" resultType="map">
		SELECT cd.cd_nm "cd_nm",
      		   vd.vdr_nm "vdr_nm", 
       		   vd.vdr_cd "vdr_cd"
        FROM   vendor vd, COMM_CODE cd
        WHERE  vd.ven_cd = cd.comm_cd
        AND    vd.vdr_nm LIKE '%'||#{vdrnm}||'%'		   
	</select>

	
</mapper>